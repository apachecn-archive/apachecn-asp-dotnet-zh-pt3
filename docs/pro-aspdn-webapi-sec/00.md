# 零、简介

风险来自于不知道自己在做什么。

—沃伦·巴菲特

很少有组织能够负担得起专门从事应用安全工作的人员。通常，团队中的开发人员或主要开发人员被委托负责将安全性改进到应用或服务中。在这个探索过程中，开发人员四处寻找，可能会搜索一些信息，在论坛上问一两个问题，并在不完全了解底层概念和他所做选择的含义的情况下推出自己的安全实现。由于项目进度的压力和缺乏对非功能性安全方面的重视或关注，通常选择阻力最小的路径。

对于应用开发团队来说，不重新发明轮子是一个很好的策略，因为像库和框架这样的可重用组件有助于以正确的方式高效地完成工作，并结合了最佳实践。无论开源与否，可重用组件的另一面是它们会导致“黑盒”综合症:事物只是工作，并继续工作，直到它们停止工作。此外，如果一个可重用的组件提供了选项，那么开发人员必须知道不同的可用选择以及这些选择的优缺点，以便对即将到来的安全需求所采用的方法做出明智的决定。

与享有诸如 WS-Trust、WS-Security 等成熟安全规范支持的基于 SOAP 的 Windows Communication Foundation(WCF)服务相比，基于 REST 的 ASP.NET Web API 目前得到的支持非常少。OAuth 2.0 相当于 REST 世界中的 WS-Trust 和 WS-Security，它还处于萌芽状态:OAuth 2.0 框架和承载令牌规范于 2012 年 10 月发布。

即使您有简单的安全需求，可以通过客户端向您的 ASP.NET Web API 提供密码进行身份验证的直接身份验证模式来满足，您是否会实现 Windows 身份验证(这是 intranet ASP.NET 应用的常用选择)或窗体身份验证(这是 Internet ASP.NET 应用的最佳选择)，或者广泛支持的基于 HTTP 的基本或摘要式身份验证？每个选项都有优点和缺点，而且没有一个通用的解决方案可以用来保护 web API。

这就是本书的由来，它向您展示了保护 ASP.NET Web API 的各种可用选项，以及这些选项的优缺点。无论您是使用自己的安全机制，还是使用库或框架形式的可重用组件，您都将能够通过了解机制的基础和所做选择的含义来做出明智的决策。

然而，这本书没有给你任何现成的、经过渗透测试的代码来直接复制和粘贴到你的产品实现中。它不会给你鱼，而是教你捕鱼。使用这本书，您可以获得与 ASP.NET Web API 相关的安全技术的坚实理解。所有潜在的概念都是从基本原则引入的，并发展到你可以自信地使用它们的程度，知道你在做什么。如果您想获得经过验证的、具有生产优势的代码，有一些优秀的开源资源:

*   Thinktecture。IdentityModel.45 为 ASP.NET Web API 提供了一个可扩展的身份验证框架，支持 SAML 1.1/2.0、JSON Web 令牌(JWT)、简单 Web 令牌(SWT)、访问密钥和 HTTP 基本身份验证。它还支持受保护的 cookies 和跨来源资源共享(CORS)。参见`https://github.com/thinktecture/Thinktecture.IdentityModel.45.`
*   Thinktecture 的 IdentityServer 2 是一个轻量级 STS，使用。NET 框架 4.5，ASP.NET MVC 4，WCF，以及同时支持 WS-Trust 和 OAuth 2.0 的 web API。参见`https://github.com/thinktecture/Thinktecture.IdentityServer.v2`。

你会学到什么

*   身份管理和加密
*   HTTP 基本和摘要式身份验证以及 Windows 身份验证
*   HTTP 高级概念，如 web 缓存、ETag 和 CORS
*   API 密钥、客户端 X.509 证书和 SAML 令牌的所有权因素
*   简单 Web 令牌(SWT)以及签名和加密的 JSON Web 令牌(JWT)
*   OAuth 2.0 使用 JWT 作为承载令牌
*   OAuth 2.0 授权码和使用 DotNetOpenAuth 的隐式授权
*   使用 Google Authenticator 的双因素认证
*   OWASP 2013 年十大风险

这本书是如何组织的

pro ASP.NET Web API 安全分为十五章。虽然没有分成几个部分，但这些章节确实倾向于归入几个相关的组。前三章构成了这样一个组，它属于核心的 ASP.NET Web API 框架。第 4 章是关于 HTTP 的独立章节。[第 5 章](05.html)、[第 6 章](06.html)、[第 7 章](07.html)组队上。身份管理和密码学的网络安全主题。[第 8 章](08.html)是关于知识要素安全的独立章节，第[章第 9 章](09.html)和第[章第 10 章](10.html)与所有权要素相关。[第 11 章](11.html)、[第 12 章](12.html)和[第 13 章](13.html)组成 OAuth 2.0 组。第 14 章是关于双因素认证的独立章节。最后，[第 15 章](15.html)，另一个独立的章节，主要关注 OWASP 安全风险。

本书各章的组织方式考虑到了一章与另一章之间可能存在的依赖关系。如果你有信心，你可以随意跳过一些章节，但是如果不了解数字签名的基础知识就试图阅读关于 SWT 的章节可能不会有很大的成效。同样，试图在不了解同源政策的含义和相关 CORS 的情况下实施隐性赠款流将是一个具有挑战性的经历。出于这个原因，从本书中获得最大收益的最好方法是顺序阅读各章，从第 1 章开始，略读你已经熟悉的任何文本。

第一章:欢迎来到 ASP.NET Web API

我们首先了解什么是 web API，然后继续学习 RESTful web API 入门，接着回顾微软的 ASP.NET web API 框架如何帮助您构建 Web API。我们用一个关于安全性的初级读本来结束这一章，它着眼于安全性的所有方面，而不仅仅是接受用户名和密码的登录屏幕，这对许多人来说就是安全这个词的含义。

第 2 章:构建 RESTful 服务

处理 XML 和/或 JSON 请求并响应 GET、POST、PUT 和 DELETE 等 HTTP 方法的 HTTP 服务不一定是 RESTful 服务。本章向您介绍了 Roy T. Fielding 的约束条件，这些约束条件是 HTTP 服务被称为 RESTful 所必须满足的，并构建了我们的第一个 web API，一个简单的 Hello-World 类型的 API。

[第三章](03.html):扩展点

ASP.NET Web API 框架在 Web API 管道中内置了各种扩展点，以便我们扩展处理管道。本章从利用过滤器和消息处理程序来确保 ASP.NET web API 在最早的可用时机处理威胁的角度出发，着重于理解 Web API 可扩展性点，如过滤器和消息处理程序。它还强调了与选择消息处理程序的 web API 扩展点而不是 HTTP 模块的 ASP.NET 扩展点进行身份验证和授权相关的权衡。

[第 4 章](04.html) : HTTP 剖析与安全

本章向您介绍超文本传输协议(HTTP)，万维网背后的协议。理解 HTTP 是理解 ASP.NET Web API 安全性的先决条件。web API 拥抱 HTTP，而不是与之对抗或将其抽象化。由于这个原因，理解 HTTP 是非常重要的:房子的坚固程度取决于它的地基！本章还介绍了 HTTP 的一些高级概念，这些概念对于创建生产级、高性能、安全的 web APIs 是必不可少的，例如 web 缓存、ETags、跨源资源共享(CORS)、cookies、代理服务器、HTTPS 以及 HTTP 调试的终极工具 Fiddler。

[第五章](05.html):身份管理

身份管理是应用安全性的一个重要方面。在这一章中，我们将重点讨论主题或实体如何得到身份验证，以及实体试图执行的操作如何在。NET 框架。本章向您介绍了构成基于角色的访问控制(RBAC)基础的接口 IIdentity 和 IPrincipal，并将其与更灵活、更细粒度的基于声明的访问控制(CBAC)进行了比较，后者是基于声明构建的。读者可以先看一下安全令牌和三种主要格式:SAML、SWT 和 JWT。

[第六章](06.html):加密和签名

Windows Identity Foundation (WIF)隐藏了令牌的具体细节，让开发人员可以处理一组声明，而无需担心加密方面的问题。当我们走出 WCF/WIF 的领域时，保护 RESTful ASP.NET Web API 而不依赖 WIF 类进行加密意味着理解加密和签名的具体细节。本章介绍使用对称密钥和非对称密钥进行加密和解密以及签名和验证:使用 RSACryptoServiceProvider 生成的公钥-私钥，以及使用 Makecert 工具生成的自签名证书。

第七章:穿越 WIF 的定制 STS

WS-Trust 方案中的一个关键组件是安全令牌服务(STS)。WIF 允许你建造你自己的定制 STS，尽管强烈建议你买一个而不是建造一个。这一简短的章节向您介绍了 WS-*协议，特别是 WS-Trust，并介绍了创建定制 STS 的步骤，以增强您对 STS 以及 STS 如何创建和颁发令牌的理解。

[第八章](08.html):知识因素

知识因素是用户知道的东西，如密码或 PIN。本章探讨了可用于保护 ASP.NET Web API 的知识因素认证机制。用户 ID 和密码组合的登录凭据可能是使用最广泛的知识因素，本章重点介绍利用这一因素的机制:HTTP 规范中定义的两种身份验证方案，即基本身份验证和摘要式身份验证，以及 Windows-OS 支持的集成 Windows 身份验证(IWA)，通常称为 Windows 身份验证。

[第九章](09.html):所有权因素

所有权因素是用户拥有或占有的东西，例如密钥、证书或令牌。本章分析了用于保护 ASP.NET Web API 的所有权因素身份验证机制，如预共享密钥(PSK)，通常称为 API 密钥、X.509 客户端证书和 SAML 令牌。

第十章:网络令牌

本章是上一章所有权因素安全性的延伸，因为 web 令牌和 SAML 令牌一样是所有权因素。然而，web 令牌值得拥有自己的一章，因为它们更适合 RESTful 服务。因此，本章专门讨论 web 令牌，并通过研究简单 web 令牌(SWT)和 JSON Web 令牌(JWT)的剖析，深入探讨两种最流行的 Web 令牌格式，包括签名(JWS)和加密(JWE)形式。

[第 11 章](11.html) : OAuth 2.0 使用 Live Connect API

OAuth 2.0 是一个开放的授权标准。粗略来说，可以认为是 REST 界的 WS-*。我们开始探索 OAuth 2.0，主要是从使用实现 OAuth 2.0 的 web API 的客户机的角度出发。我们回顾了四种授权类型，并使用 Microsoft Live Connect API 详细了解了隐式授权和基于授权代码的授权。

[第 12 章](12.html) : OAuth 2.0 从头开始

在这一章中，我们移到桌子的另一边。现在，我们不再关注使用 API 的客户端，而是开发一个实现 OAuth 2.0 的 web API，特别是基于授权代码的授权。实现是使用两个 ASP.NET MVC web 应用从头开始执行的，因此您可以理解具体细节。

[第十三章](13.html) : OAuth 2.0 使用 DotNetOpenAuth

虽然可以在前一章的 OAuth 2.0 实现的基础上进行构建，并开发您的生产级 OAuth 2.0 实现，但本章使用 DotNetOpenAuth (DNOA)实现了相同的基于授权代码的授权，这是一个成熟的开源软件。NET 库，它帮助您为您的 web API 编写基于生产级 OAuth 2.0 的授权，符合不重复发明轮子的原则。

第十四章:双因素认证

当您有一个利用知识、所有权和固有因素中的两个因素的组合的身份验证机制时，它被称为双因素身份验证(TFA 或 2FA)。本章通过利用密码的知识因素、X.509 客户端证书的所有权因素以及通过使用 Google Authenticator 提供的 TOTP 代码实现的按需 TFA 来介绍 TFA。

[第十五章](15.html):安全漏洞

本章着眼于重要的和潜在的安全风险或漏洞，与 ASP.NET Web API 相关的兴趣点，以及在构建一个安全的、生产级的 ASP.NET Web API 时需要注意的事项。根据 OWASP 2013，覆盖范围包括主要风险，以及日志记录和验证等最佳实践。

[附录](16.html):ASP.NET Web API 安全精华

这个附录是这本书的一个重要总结，概括了书中涉及的各种安全机制。因为没有绝对意义上的好与坏的机制，所以这本书的思路就是把所有的机制都呈现给你，让你根据自己的需求来决定。本附录概述了这些选项。

你需要什么来使用这本书

尽管本书中的所有代码清单和示例都是使用 Visual Studio 2012 针对。NET 框架 4.5。如果您使用 Visual Studio 2010，您将需要 WIF 运行时以及 WIF SDK，它们可作为独立安装。

值得注意的重要一点是，WIF 已经完全融入了。NET Framework 从。NET Framework 4.5，包括工具和类。作为此过程的一部分，类和命名空间(类是。NET Framework 4.0 与。NET 框架 4.5。如果您使用 Visual Studio 2010 和。NET Framework 4.0，您将需要查看本书之外的资源来弄清楚。本书中使用的代码和配置设置的. NET Framework 4.0 等效版本。

本书中所有代码的语言选择是 C#。虽然有视觉 Basic.NET 的人在那里，但展示视觉 Basic.NET 的等价物是不可行的，因为那会增加书的大小。毕竟，理解 C# 语法并不难！

ASP.NET Web API 是 ASP.NET MVC 4.0 的一部分。它随 Visual Studio 2012 一起提供。同样，如果你有必须使用 Visual Studio 2010 的限制，你必须通过访问`http://www.asp.net/mvc/mvc4`安装 ASP.NET MVC 4.0。

底线是 Visual Studio 2012 和。强烈建议使用. NET Framework 4.5。如果您真的下定决心，那么您可以使用 Visual Studio 2010 针对。NET 框架 4.0。但是，您将无法按原样运行本书提供的代码示例，您需要修改 C# 代码和配置设置，以使它们能够与。NET 框架 4.0。本书中的所有示例都是在 Windows 7 中使用 Visual Studio 2012 针对。NET 框架 4.5。还有，你需要 IIS 7.0。

我们使用的浏览器多为 9.0 对于一些特定情况，我们使用 Mozilla Firefox 或 Google Chrome。我们还使用名为 Fiddler 的 HTTP 调试工具。其中一章可选地使用了运行在 iOS、黑莓和基于 Android 的手机上的谷歌认证软件。

这本书是给谁的

没有以前的经验。看这本书需要网络安全。所有与安全相关的概念都是从基本原则开始介绍的，并发展到您可以在专业环境中自信地使用它们的程度。良好的 C# 和。NET 框架是受益于这本书的唯一先决条件。